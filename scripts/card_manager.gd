extends Node
class_name CardManager

@export var camera: Camera2D
@export var cards: Array[Node2D]
@export var turn_indicator: Node2D

var table_cards: Array

var viewport_rect: Rect2
var players_position: Array[Vector2]

# keep track of what card each player has in hand
var players_cards: Array = []
# number of players
var total_players := 4
# number of cards
var total_cards := 40
# actual size of the card
var card_size := Vector2(16, 16)

func get_scale_value(width):
	return width / 100

func set_indicator_scale(width):
	var scale_value = get_scale_value(width)
	var scale = Vector2(scale_value, scale_value)
	turn_indicator.scale = scale

func set_cards_scale(width):
	var scale_value = get_scale_value(width)
	var scale = Vector2(scale_value, scale_value)
	card_size = card_size * scale_value
	for c in cards:
		c.scale = scale

func _ready() -> void:
	for i in range(total_players):
		players_cards.append([])
	
	viewport_rect = camera.get_viewport_rect()
	set_cards_scale(viewport_rect.size.x)
	set_indicator_scale(viewport_rect.size.x)
	# hide turn indicator
	turn_indicator.visible = false
	
	#print(viewport_rect.size.x)
	var half_w = viewport_rect.size.x / 2
	var half_h = viewport_rect.size.y / 2
	var distance_from_border = (0.1 * viewport_rect.size.x)
	var main_player_distance_from_border = (0.25 * viewport_rect.size.x)
	# p0 = [0, -(h/2) + (0.1 * w)]
	players_position.append(Vector2(0, -half_h + distance_from_border))
	# p1 = [(w/2) - (0.1 * w), 0]
	players_position.append(Vector2(half_w - distance_from_border, 0))
	# p2 = [0, (h/2) - (0.1 * w)]
	players_position.append(Vector2(0, half_h - main_player_distance_from_border))
	# p3 = [- (w/2) + (0.1 * w), 0]
	players_position.append(Vector2(- half_w + distance_from_border, 0))
	
func reposition_player_cards(player_index: int, cards: Array):
	var distance_to_next  = viewport_rect.size.x * 0.4 / 10
	if player_index == 0:
		distance_to_next  = viewport_rect.size.x * 0.8 / 10
	var cards_number = cards.size()
	var initial_positition = (cards_number - 1) * -0.5 * distance_to_next
	var initial_rotation_top_bottom = -10 * (cards_number -1) /2
	var initial_rotation_left_right = 10 * (cards_number -1) /2
	
	var i = 0
	for card in cards:
		var arch_offset = 4 * (i - (cards_number -1) /2) * (i - (cards_number -1) /2)
		match player_index:
			0:
				# y offset is based on the index, similar to an arc
				# need a function where 0 is -arch_height / 2, middle is +arch_height / 2, end is -arch_height / 2
				#var arch_offset = 4 * (i - (cards_number -1) /2) * (i - (cards_number -1) /2)
				card.target_position = players_position[2] + Vector2(initial_positition + (distance_to_next * i), arch_offset)
				card.target_rotation = initial_rotation_top_bottom + 10 * i
			1:
				card.target_position = players_position[1] + Vector2(arch_offset, initial_positition + (distance_to_next * i))
				card.target_rotation = -90 + initial_rotation_left_right - 10 * i 
			2:
				card.target_position = players_position[0] + Vector2(- initial_positition - (distance_to_next * i), - arch_offset)
				card.target_rotation = 180 + initial_rotation_top_bottom + 10 * i
			3:
				card.target_position = players_position[3] + Vector2(- arch_offset, - initial_positition - (distance_to_next * i))
				card.target_rotation = 90 + initial_rotation_left_right - 10 * i
		card.has_reached_position = false
		card.has_reached_rotation = false
		i += 1
	
func update_turn_indicator(player_index: int):
	turn_indicator.visible = true
	match player_index:
		0:
			turn_indicator.position = players_position[2] - Vector2(0, card_size.y)
			turn_indicator.rotation_degrees = 180
		1:
			turn_indicator.position = players_position[1] - Vector2(card_size.x, 0)
			turn_indicator.rotation_degrees = 90
		2:
			turn_indicator.position = players_position[0] + Vector2(0, card_size.y)
			turn_indicator.rotation_degrees = 0
		3:
			turn_indicator.position = players_position[3] + Vector2(card_size.x, 0)
			turn_indicator.rotation_degrees = -90

func give_cards(main_player_cards: Array):
	# give one card to each player till al the cards are given
	for i in range(total_cards):
		var player_index = i % total_players
		if player_index == 0:
			var cards_player_index := i / total_players
			cards[i].card = main_player_cards[cards_player_index]
		players_cards[player_index].append(cards[i])
		reposition_player_cards(player_index, players_cards[player_index])
		await get_tree().create_timer(0.3).timeout
	
func place_card_on_table(played_card: Node2D):
	
	# add card to table cards
	table_cards.append(played_card)
	# reposition all table cards, place the cards in rows of 3 elements
	var cards_number = table_cards.size()
	var cards_rows = int((cards_number - 1) / 3) + 1
	for i in range(cards_number):
		# position cards in rows of 3, on the last row center the cards
		var row_index = int(i / 3)
		var col_index = i % 3
		var row_cards_number = 3
		if row_index == cards_rows - 1:
			row_cards_number = cards_number - (row_index * 3)
		var initial_positition = (row_cards_number - 1) * -0.5 * card_size.x
		var target_x = initial_positition + (col_index * card_size.x)
		var target_y = - (cards_rows - 1) * 0.5 * card_size.y + (row_index * card_size.y)
		played_card = table_cards[i]
		played_card.target_position = Vector2(target_x, target_y)
		played_card.target_rotation = 0
		played_card.has_reached_position = false
		played_card.has_reached_rotation = false
	
	
func play_card(player_index: int, card: int):
	turn_indicator.visible = false

	var played_player_card = null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
	if player_index != 0:
		# get the first available card and set the played card value and play it
		played_player_card = players_cards[player_index].pop_back()
		played_player_card.card = card
	else:
		# main player, the exact card needs to be played
		var i = 0
		for c in players_cards[player_index]:
			if c.card == card:
				played_player_card = players_cards[player_index].pop_at(i)
			else:
				i += 1
	
	place_card_on_table(played_player_card)
	reposition_player_cards(player_index, players_cards[player_index])
	await get_tree().create_timer(0.3).timeout
	
func get_collect_position(player_index: int):
	match player_index:
		0:
			return Vector2(0, viewport_rect.size.y)
		1:
			return Vector2(viewport_rect.size.x, 0)
		2:
			return Vector2(0, -viewport_rect.size.y)
		3:
			return Vector2(-viewport_rect.size.x, 0)
	return Vector2()
	
func collect_cards(player_index, cards: Array):
	for card in table_cards:
		if card.card in cards:
			card.target_position = Vector2()
			card.target_rotation = 0
			card.has_reached_position = false
			card.has_reached_rotation = false
	await get_tree().create_timer(0.3).timeout

	var indices_to_remove = []
	var i := 0

	for card in table_cards:
		if card.card in cards:
			card.target_position = get_collect_position(player_index)
			card.target_rotation = 0
			card.has_reached_position = false
			card.has_reached_rotation = false
			indices_to_remove.append(i)
		i += 1
	
	indices_to_remove.reverse()
	for j in indices_to_remove:
		table_cards.remove_at(j)

	await get_tree().create_timer(0.5).timeout

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta: float) -> void:
	pass

func simple_aabb_collision(point: Vector2, rect_position: Vector2, rect_size: Vector2) -> bool:
	return point.x >= rect_position.x - rect_size.x / 2 and point.x <= rect_position.x + rect_size.x / 2 and \
		point.y >= rect_position.y - rect_size.y / 2 and point.y <= rect_position.y + rect_size.y / 2

func get_player_cards_at_position(position: Vector2) -> Array[Node2D]:
	var result: Array[Node2D] = []
	for player_card in players_cards[0]:
		var card_rect_position = player_card.position
		if simple_aabb_collision(position, card_rect_position, card_size):
			result.append(player_card)
	return result
